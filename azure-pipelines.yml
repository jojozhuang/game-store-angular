trigger:
- deploy-to-gaâ€¦ure-pipeline

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build
  displayName: Build Angular App
  jobs:
  - job: Build
    displayName: Build
    steps:
    - checkout: self

    - task: NodeTool@0
      displayName: 'Use Node.js 22'
      inputs:
        versionSpec: '22.x'

    - script: |
        npm install
        npm run build
        npm run test-headless
      displayName: 'Install, Build and Test'

    - task: PublishBuildArtifacts@1
      displayName: 'Publish artifact'
      inputs:
        PathtoPublish: 'dist/browser'
        ArtifactName: 'node-app'
        publishLocation: 'Container'

- stage: Deploy
  displayName: Deploy to Azure Web App
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: Deploy
    steps:
    - checkout: none

    - task: DownloadBuildArtifacts@0
      displayName: 'Download build artifact'
      inputs:
        artifactName: 'node-app'

    - task: AzureWebApp@1
      displayName: 'Deploy to App Service'
      inputs:
        azureSubscription: 'DreamSpark'   # <-- Change this
        appName: 'game-store-angular3'
        slotName: 'Production'
        package: '$(Pipeline.Workspace)/node-app'
        enableCustomDeployment: true
        DeploymentMethod: 'zipDeploy'
        clean: true
